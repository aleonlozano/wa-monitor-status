<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel WhatsApp Monitor</title>
    <!-- Bootstrap CSS desde CDN para un diseño rápido y limpio -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    >
    <style>
        body {
            background-color: #f5f6fa;
        }
        .brand-bar {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: #fff;
        }
        .stat-card {
            border-radius: 0.75rem;
        }
        .table thead th {
            background-color: #f0f2f5;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg brand-bar mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 text-white">WhatsApp Monitor</span>
        <div class="d-flex align-items-center text-white-50">
            <small class="me-3">Panel de estudio e investigación</small>
            <a href="/admin/" class="btn btn-sm btn-light">Ir al Admin</a>
        </div>
    </div>
</nav>

<div class="container mb-5">
    <!-- Fila de estado de conexión y métricas globales -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card stat-card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Estado de WhatsApp</h6>
                    {% if wa_connected %}
                        <h4 class="card-title text-success mb-1">
                            Conectado
                        </h4>
                        {% if wa_user %}
                            <p class="mb-1 small">Usuario: {{ wa_user.id }} ({{ wa_user.name|default:"Sin nombre" }})</p>
                        {% endif %}
                        <span class="badge bg-success">Online</span>

                        <!-- Botón para cerrar sesión y forzar nuevo QR -->
                        <form method="post" action="{% url 'wa_logout' %}" class="mt-3">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                Cerrar sesión y generar nuevo QR
                            </button>
                        </form>
                    {% else %}
                        <h4 class="card-title text-danger mb-1">Desconectado</h4>

                        {% if wa_qr %}
                            <p class="mb-1 small">
                                Escanea el código QR con WhatsApp en tu celular
                                (<strong>Dispositivos vinculados &gt; Vincular un dispositivo</strong>).
                            </p>
                        {% else %}
                            <p class="mb-1 small">
                                No hay un código QR activo en este momento.
                                Puedes generarlo cuando lo necesites.
                            </p>
                        {% endif %}

                        {% if wa_error %}
                            <p class="text-muted small">Error: {{ wa_error }}</p>
                        {% endif %}

                        <span class="badge bg-danger">Offline</span>

                        <!-- Botón para pedir a Node que inicie sesión y genere un nuevo QR -->
                        <form method="post" action="{% url 'wa_start_session' %}" class="mt-2 d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                Generar nuevo QR
                            </button>
                        </form>

                        {% if wa_qr %}
                            <!-- Si además ya hay QR, se puede ver en modal -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-success mt-2 ms-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#waQrModal">
                                Mostrar QR
                            </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="row g-3">
                <div class="col-6 col-lg-3">
                    <div class="card stat-card shadow-sm h-100">
                        <div class="card-body">
                            <p class="text-muted mb-1 small">Campañas totales</p>
                            <h3 class="mb-0">{{ stats.total_campaigns }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stat-card shadow-sm h-100">
                        <div class="card-body">
                            <p class="text-muted mb-1 small">Campañas activas</p>
                            <h3 class="mb-0">{{ stats.active_campaigns }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stat-card shadow-sm h-100">
                        <div class="card-body">
                            <p class="text-muted mb-1 small">Contactos</p>
                            <h3 class="mb-0">{{ stats.total_contacts }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stat-card shadow-sm h-100">
                        <div class="card-body">
                            <p class="text-muted mb-1 small">Resultados</p>
                            <h3 class="mb-0">{{ stats.total_results }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Listados recientes -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Campañas recientes</h5>
                </div>
                <div class="card-body p-0">
                    {% if campaigns %}
                        <div class="table-responsive">
                            <table class="table mb-0 align-middle">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Estado</th>
                                        <th>Contactos</th>
                                        <th>Creada</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for c in campaigns %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'campaign_detail' c.id %}">
                                                    {{ c.name }}
                                                </a>
                                            </td>
                                            <td>
                                                {% if c.is_active %}
                                                    <span class="badge bg-success">Activa</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactiva</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ c.contacts.count }}</td>
                                            <td class="small text-muted">{{ c.created_at|date:"d/m/Y H:i" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="p-3 mb-0 text-muted">Aún no hay campañas creadas.</p>
                    {% endif %}
                </div>
                <div class="card-footer bg-white text-end">
                    <a href="/campaigns/" class="btn btn-sm btn-outline-primary">
                        Ver todas las campañas
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Contactos recientes</h5>
                    <small class="text-muted">Haz clic para ver historias</small>
                </div>
                <div class="card-body p-0">
                    {% if contacts %}
                        <div class="table-responsive">
                            <table class="table mb-0 align-middle">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Teléfono</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ct in contacts %}
                                        <tr>
                                            <td>{{ ct.name }}</td>
                                            <td>{{ ct.phone_number }}</td>
                                            <td>
                                                <a href="{% url 'contact_stories' ct.id %}" class="btn btn-sm btn-outline-primary">
                                                    Ver historias
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="p-3 mb-0 text-muted">Aún no hay contactos registrados.</p>
                    {% endif %}
                </div>
                <div class="card-footer bg-white text-end">
                    <a href="/contacts/" class="btn btn-sm btn-outline-primary">
                        Ver todos los contactos
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4 mt-4">
        <div class="col-xl-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Top contactos que más han cumplido</h5>
                </div>
                <div class="card-body">
                    {% if top_contacts_best %}
                        <ul class="list-group list-group-flush">
                            {% for item in top_contacts_best %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">
                                            {{ item.contact__name|default:"Sin nombre" }}
                                        </div>
                                        <small class="text-muted">{{ item.contact__phone_number }}</small>
                                    </div>
                                    <span class="badge bg-success rounded-pill">
                                        {{ item.total_cumple }}
                                    </span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">Aún no hay resultados suficientes.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Top contactos que menos han cumplido</h5>
                </div>
                <div class="card-body">
                    {% if top_contacts_worst %}
                        <ul class="list-group list-group-flush">
                            {% for item in top_contacts_worst %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">
                                            {{ item.contact__name|default:"Sin nombre" }}
                                        </div>
                                        <small class="text-muted">{{ item.contact__phone_number }}</small>
                                    </div>
                                    <span class="badge bg-danger rounded-pill">
                                        {{ item.total_bad }}
                                    </span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">Aún no hay resultados suficientes.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Distribución de resultados</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusPieChart" height="220"></canvas>
                    <p class="text-muted small mt-3 mb-0">
                        Cumplen: {{ status_counts.cumple|default:"0" }} ·
                        Incumplen: {{ status_counts.incumple|default:"0" }} ·
                        No capturados: {{ status_counts.no_capturado|default:"0" }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mt-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Top campañas más exitosas</h5>
                    <small class="text-muted">Ordenadas por tasa de cumplidos</small>
                </div>
                <div class="card-body">
                    {% if top_campaigns_best %}
                        <div class="table-responsive">
                            <table class="table mb-0 align-middle">
                                <thead>
                                    <tr>
                                        <th>Campaña</th>
                                        <th class="text-center">Cumplen</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">Tasa</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for c in top_campaigns_best %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'campaign_detail' c.id %}">
                                                    {{ c.name }}
                                                </a>
                                            </td>
                                            <td class="text-center">{{ c.total_cumple }}</td>
                                            <td class="text-center">{{ c.total_results }}</td>
                                            <td class="text-center">{{ c.success_rate|floatformat:0 }}%</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Aún no hay campañas con resultados.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Top campañas menos exitosas</h5>
                    <small class="text-muted">Ordenadas por tasa de cumplidos</small>
                </div>
                <div class="card-body">
                    {% if top_campaigns_worst %}
                        <div class="table-responsive">
                            <table class="table mb-0 align-middle">
                                <thead>
                                    <tr>
                                        <th>Campaña</th>
                                        <th class="text-center">Cumplen</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">Tasa</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for c in top_campaigns_worst %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'campaign_detail' c.id %}">
                                                    {{ c.name }}
                                                </a>
                                            </td>
                                            <td class="text-center">{{ c.total_cumple }}</td>
                                            <td class="text-center">{{ c.total_results }}</td>
                                            <td class="text-center">{{ c.success_rate|floatformat:0 }}%</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Aún no hay campañas con resultados.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if not wa_connected %}
<div class="modal fade" id="waQrModal" tabindex="-1" aria-labelledby="waQrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="waQrModalLabel">Conecta tu cuenta de WhatsApp</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <p class="text-muted mb-3">
                    Escanea este código QR desde WhatsApp en tu celular
                    (<strong>Dispositivos vinculados &gt; Vincular un dispositivo</strong>).
                </p>
                {% if wa_qr %}
                    <div class="d-flex justify-content-center mb-3">
                        <img
                            src="https://api.qrserver.com/v1/create-qr-code/?data={{ wa_qr|urlencode }}&amp;size=240x240"
                            alt="Código QR de WhatsApp"
                            class="img-fluid rounded shadow-sm"
                        >
                    </div>
                    <p class="text-muted small mb-0">
                        Mantén esta ventana abierta mientras se conecta. La página se recargará automáticamente al detectar la conexión.
                    </p>
                {% else %}
                    <p class="text-danger mb-0">
                        No se pudo obtener el código QR. Verifica que el backend de WhatsApp (Node.js) esté corriendo.
                    </p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% if wa_qr %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Mostrar automáticamente el modal cuando hay QR disponible y la sesión no está conectada
        var modalEl = document.getElementById('waQrModal');
        if (modalEl) {
            var qrModal = new bootstrap.Modal(modalEl);
            qrModal.show();
        }

        // Polling al backend Django para detectar cuando se conecta y recargar la página
        function pollWaStatus() {
            fetch("{% url 'wa_status_api' %}")
                .then(function (response) { return response.json(); })
                .then(function (data) {
                    if (data.connected) {
                        window.location.reload();
                    } else {
                        setTimeout(pollWaStatus, 4000);
                    }
                })
                .catch(function () {
                    // En caso de error, reintentar más tarde
                    setTimeout(pollWaStatus, 6000);
                });
        }

        pollWaStatus();
    });
</script>
{% endif %}
{% endif %}

<!-- Bootstrap JS (opcional, solo si luego usas componentes que lo requieran) -->
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
></script>

<!-- Chart.js para la gráfica en torta -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var canvas = document.getElementById('statusPieChart');
        if (!canvas) {
            return;
        }

        var data = {
            labels: ['Cumplen', 'Incumplen', 'No capturados'],
            datasets: [{
                data: [
                    {{ status_counts.cumple|default:"0" }},
                    {{ status_counts.incumple|default:"0" }},
                    {{ status_counts.no_capturado|default:"0" }}
                ]
            }]
        };

        new Chart(canvas, {
            type: 'pie',
            data: data,
            options: {
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });
</script>
</body>
</html>